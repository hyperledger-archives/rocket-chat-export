#!/bin/bash

# Author: Martin Schneider
# Copyright (c) Actiware Development GmbH

joinChannel() {
    ##### Umgebungvariablen setzen #####

    # Frage wo die configtx.yaml liegt und setze die Umgebungvariable FABRIC_CFG_PATH
    #read -p "Wo liegt die core.yaml für den peer der dem Channel hinzugefügt werden soll: " configtxpath

export CORE_PEER_LOCALMSPID="Org1MSP"
export CORE_PEER_TLS_ROOTCERT_FILE=$PWD/organizations/peerOrganizations/org1.actiware.com/peers/peer1.org1.actiware.com/tls/ca.cert
export CORE_PEER_MSPCONFIGPATH=$PWD/organizations/peerOrganizations/org1.actiware.com/users/Admin@org1.actiware.com/msp
export CORE_PEER_ADDRESS=localhost:8051
export FABRIC_CFG_PATH=$PWD/newPeer/config

BLOCKFILE=$PWD/channel-artifacts/awchannel.block

echo "use core.yaml from: $FABRIC_CFG_PATH"
echo "Use core peer localmspid: $CORE_PEER_LOCALMSPID"
echo "USe tls rootcertfiel: $CORE_PEER_TLS_ROOTCERT_FILE"
echo "Use Mspconfigpath: $CORE_PEER_MSPCONFIGPATH"
echo "Use adress: $CORE_PEER_ADDRESS"

echo "channel fetch genesis block"
peer channel fetch config -o [IP OF 1. Ubuntu Machine]:7050 --ordererTLSHostnameOverride orderer.actiware.com -c awchannel --tls --cafile $PWD/organizations/ordererOrganizations/actiware.com/orderers/orderer.actiware.com/msp/tlscacerts/tlsca.actiware.com-cert.pem

##### peer dem channel hinzufügen #####

    # Frage wo die block datei ist
    #read -p "Wo liegt die channel_name.block Datei?: " blockfile

    DELAY=3
    MAX_RETRY=5
    local rc=1
	local COUNTER=1
	## Sometimes Join takes time, hence retry
	while [ $rc -ne 0 -a $COUNTER -lt $MAX_RETRY ]; do
        sleep $DELAY
        peer channel join -b $BLOCKFILE
        res=$?
		let rc=$res
		COUNTER=$(expr $COUNTER + 1)
	done
}

joinChannel